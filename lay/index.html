<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>lay prototype</title>
<link rel="stylesheet" href="./base.css">
<link rel="stylesheet" href="./index.css">
<script src="maquette.min.js"></script>
<script>
var jsonObject = {
  TodoMVC: {
    domain: {
      Task: {
        _constructor: "Entity",
        title: "string",
        completed: "bool"
      },
      tasks: {
        _contents: [
          {
            _constructor: "Task",
            title: "buy a milk",
            completed: false,
          },
          {
            _constructor: "Task",
            title: "buy a coffee",
            completed: false,
          },
          {
            _constructor: "Task",
            title: "buy a tea",
            completed: true,
          }
        ]
      }
    },
    presentation: {
      _constructor: "DOM::Document",
      body: {
        _constructor: "Body",
        _contents: [
          {
            _constructor: "Section",
            class: "todoapp",
            _contents: [
              {
                _constructor: "Div",
                _contents: [
                  {
                    _constructor: "Header",
                    class: "header",
                    _contents: [
                      {
                        _constructor: "H1",
                        _contents: [
                          "todos"
                        ]
                      },
                      {
                        _constructor: "Input",
                        class: "new-todo",
                        placeholder: "What needs to be done?"
                      }
                    ]
                  },
                  {
                    _constructor: "Section",
                    class: "main",
                    _contents: [
                      {
                        _constructor: "Input",
                        class: "toggle-all",
                        type: "checkbox"
                      },
                      {
                        _constructor: "Ul",
                        class: "todo-list",
                        _contents: [
                          {
                            _constructor: "domain.tasks.map",
                            _contents: [
                              {
                                task: "Task",
                                _contents: [
                                  {
                                    _constructor: "Li",
                                    _contents: [
                                      {
                                        _constructor: "Div",
                                        class: "view",
                                        _contents: [
                                          {
                                            _constructor: "Input",
                                            class: "toggle",
                                            type: "checkbox",
                                          },
                                          {
                                            _constructor: "Label",
                                            _contents: [
                                              {
                                                _constructor: "Ref",
                                                _path: "task.title"
                                              }
                                            ]
                                          },
                                          {
                                            _constructor: "Button",
                                            class: "destroy",
                                          }
                                        ]
                                      },
                                      {
                                        _constructor: "Input",
                                        class: "edit",
                                        value: {
                                          _constructor: "Ref",
                                          _path: "task.title"
                                        }
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    _constructor: "Footer",
                    class: "footer",
                    _contents: [
                      {
                        _constructor: "Span",
                        class: "todo-count",
                        _contents: [
                          {
                            _constructor: "Strong",
                            _contents: [
                              "1"
                            ]
                          },
                          {
                            _constructor: "Span",
                          },
                          {
                            _constructor: "Span",
                            _contents: [
                              "item"
                            ]
                          },
                          {
                            _constructor: "Span",
                            _contents: [
                              " left"
                            ]
                          }
                        ]
                      },
                      {
                        _constructor: "Ul",
                        class: "filters",
                        _contents: [
                          {
                            _constructor: "Li",
                            _contents: [
                              {
                                _constructor: "A",
                                href: "#/",
                                class: "selected",
                                _contents: [
                                  "All"
                                ]
                              }
                            ]
                          },
                          {
                            _constructor: "Span",
                          },
                          {
                            _constructor: "Li",
                            _contents: [
                              {
                                _constructor: "A",
                                href: "#/active",
                                _contents: [
                                  "Active"
                                ]
                              }
                            ]
                          },
                          {
                            _constructor: "Span",
                          },
                          {
                            _constructor: "Li",
                            _contents: [
                              {
                                _constructor: "A",
                                href: "#/completed",
                                _contents: [
                                  "Completed"
                                ]
                              }
                            ]
                          },
                        ]
                      },
                      {
                        _constructor: "Button",
                        class: "clear-completed",
                        _contents: [
                          "Clear Completed"
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            _constructor: "Footer",
            class: "info",
            _contents: [
              {
                _constructor: "P",
                _contents: [
                  "Double-click to edit a todo"
                ]
              },
              {
                _constructor: "P",
                _contents: [
                  "Created by ",
                  {
                    _constructor: "A",
                    href: "http://github.com/emeitch/",
                    _contents: [
                      "Hideyuki MORITA (emeitch)"
                    ]
                  }
                ]
              },
              {
                _constructor: "P",
                _contents: [
                  "Part of ",
                  {
                    _constructor: "A",
                    href: "http://todomvc.com",
                    _contents: [
                      "TodoMVC"
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    }
  }
}

function flatten(array) {
  return Array.prototype.concat.apply([], array);
}

const PRIMITIVE_TYPES = [
  "number",
  "string",
  "boolean"
];

const HTML_TAGS = [
  "Body",
  "Section",
  "Footer",
  "Header",
  "P",
  "Ul",
  "Li",
  "Input",
  "Button",
  "Div",
  "Span",
  "H1",
  "Label",
  "Strong",
  "A",
]

function box(src={}, parent=undefined) {
  const type = typeof(src);
  if (PRIMITIVE_TYPES.includes(type)) {
    return new Primitive(src, parent);
  }
  
  if (src._constructor === "Ref") {
    return new Ref(src, parent);
  }
  
  if (HTML_TAGS.includes(src._constructor)) {
    return new DOM(src, parent);
  }
  
  if (src._constructor === "Entity") {
    return new Entity(src, parent);
  }

  return new Box(src, parent);
}

class Box {
  constructor(src, parent) {
    this._parent = parent;
    
    this._constructorPath = src._constructor ? src._constructor : "Box"
    
    if (typeof(src) === "object") {
      Object.getOwnPropertyNames(src)
      .filter(n => n[0] != "_")
      .forEach(c => {
        this[c] = box(src[c], this);
      });
    }
    
    var contents = src._contents ? src._contents : [];
    this._contents = contents.map(b => box(b, this));
  }
  
  _copy(parent) {
    let copy = new this.constructor({}, parent);
    
    copy._constructorPath = this._constructorPath;
    
    this._propertyNames.forEach(n => {
      copy[n] = this[n]._copy(copy);
    });
    
    copy._contents = this._contents.map(c => c._copy(copy));
        
    return copy;
  }
  
  get _propertyNames() {
    return Object.getOwnPropertyNames(this)
      .filter(n => n[0] != "_");
  }
  
  get _properties() {
    return this._propertyNames
      .reduce((r, n) => {
        r[n] = this[n];
        return r;
      }, {});
  }
  
  _construct(src, parent) {
    let copy = src._copy(parent);
    copy._propertyNames.forEach(n => {
      copy[n] = copy[n]._expand(copy);
    });
    copy._contents = copy._contents.map(c => c._expand(copy));
    return copy;
  }
  
  _ref(path) {
    const syms = path.split(".");
    
    if (this[syms[0]]) {
      return syms.reduce((p, s) => p[s], this);      
    }
    
    if (this._parent) { 
      return this._parent._ref(path);
    }
    
    return box(); // todo ダミーBoxを返している状況なので変更する
  }
  
  _expand(parent=this._parent) {
    const constructor = this._ref(this._constructorPath);
    return constructor._construct(this, parent);
  }
  
  _eval() {    
    return this;
  }
  
  _render() {
    return flatten(this._contents.map(b => b._render()));
  }
  
  get map() {
    class Map extends Box {
      _construct(src, parent) {
        const block = src._contents[0];
        const key = block._propertyNames[0]; // todo key値の型と一致するか確認
        const dst = box({}, parent);
        dst._contents = this._parent._contents.map(item => {
          // todo _contentsにMapボックスが存在すると無限ループになるのをうまく解決 / そもそも_contentsがMapボックスになる状況のセマンティクスとは何か?
          const n = block._copy(dst);
          n[key] = item;
          return n._expand(dst);
        });
        return dst;
      }
    }
    return new Map({}, this);
  }
}

class Primitive extends Box {
  constructor(src, parent) {
    super(src, parent);
    this._value = src;
  }
  
  _copy(parent) {
    let copy = super._copy(parent);
    copy._value = this._value;
    return copy;
  }
  
  _eval() {
    return this._value;
  }
  
  _render() {
    return [this._eval()];
  }
}

class Entity extends Box {
}

class Ref extends Box {
  constructor(src, parent) {
    super(src, parent);
    this._path = src._path;
  }
  
  _copy(parent) {
    let copy = super._copy(parent);
    copy._path = this._path;
    return copy;
  }

  _eval() {
    return this._ref(this._path);
  }
  
  _render() {
    return flatten([this._eval()._render()]);
  }
}

class DOM extends Box {
  constructor(src, parent) {
    super(src, parent);
    this._tag = src._constructor;
  }

  _copy(parent) {
    let copy = super._copy(parent);
    copy._tag = this._tag;
    return copy;
  }

  _render() {
    const properties = this._propertyNames.reduce((r, n) => Object.assign(r, {[n]: this[n]._render()[0]}), {});
    const children = flatten(this._contents.map(b => b._render()));
    return [maquette.h(
      this._tag,
      properties,
      children
    )];
  }
}

// // test
// console.log(box({
//   a: 1,
//   b: 2,
//   c: {
//     ca: 3
//   }
// })._ref("c.ca")._value == 3);
// 
// var src = {
//   a: {
//     aa: 1,
//     ab: 2
//   },
//   b: 3,
//   c: {
//     ca: {
//       a: {
//         ab: 4
//       },
//       caa: {
//         caaa: 5
//       },
//       cab: {
//         caaa: 6
//       }
//     }
//   }
// };
// console.log(box(src)._ref("c")._ref("a.ab")._value == 2);
// console.log(box(src)._ref("c.ca")._ref("a.ab")._value == 4);
// console.log(box(src)._ref("c.ca.caa.caaa")._ref("a.ab")._value == 4);
// 
// console.log(box({
//   a: {
//     _constructor: "Box",
//     _contents: [
//       "hoge",
//       "fuga"
//     ]
//   },
//   b: {
//     _constructor: "a.map",
//     _contents: [
//       {
//         text: "string",
//         _contents: [
//           {
//             _constructor: "Span",
//             _contents: [
//               {
//                 _constructor: "Ref",
//                 _path: "text"
//               }
//             ]
//           }
//         ]
//       }
//     ]
//   }
// })._expand());

function vdom(app) { 
  const body = app.presentation.body;
  return body._expand()._render()[0];
}

const tree = box(jsonObject);

// Initializes the projector 
var projector = maquette.createProjector();
window.document.addEventListener('DOMContentLoaded', function () {
   projector.replace(window.document.body, () => vdom(tree.TodoMVC));
});

</script>
</head>
<body>
</body>
</html>