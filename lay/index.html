<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>lay prototype</title>
<link rel="stylesheet" href="./base.css">
<link rel="stylesheet" href="./index.css">
<script src="maquette.min.js"></script>
<script>
var json = {
  TodoMVC: {
    _constructor: "Module",
    domain: {
      _constructor: "Module",
      Task: {
        _constructor: "Entity",
        title: "string",
        completed: "bool"
      },
      tasks: {
        _constructor: "Array",
        _blocks: [
          {
            _constructor: "Task",
            title: "buy a milk",
            completed: false,
          },
          {
            _constructor: "Task",
            title: "buy a coffee",
            completed: false,
          },
          {
            _constructor: "Task",
            title: "buy a tea",
            completed: true,
          }
        ]
      }
    },
    presentation: {
      _constructor: "DOM::Document",
      body: {
        _constructor: "Body",
        _blocks: [
          {
            _constructor: "Section",
            class: "todoapp",
            _blocks: [
              {
                _constructor: "Div",
                _blocks: [
                  {
                    _constructor: "Header",
                    class: "header",
                    _blocks: [
                      {
                        _constructor: "H1",
                        _blocks: [
                          "todos"
                        ]
                      },
                      {
                        _constructor: "Input",
                        class: "new-todo",
                        placeholder: "What needs to be done?"
                      }
                    ]
                  },
                  {
                    _constructor: "Section",
                    class: "main",
                    _blocks: [
                      {
                        _constructor: "Input",
                        class: "toggle-all",
                        type: "checkbox"
                      },
                      {
                        _constructor: "Ul",
                        class: "todo-list",
                        _blocks: [
                          {
                            _constructor: "domain.tasks.map",
                            task: "Task",
                            _blocks: [
                              {
                                _constructor: "Li",
                                _blocks: [
                                  {
                                    _constructor: "Div",
                                    class: "view",
                                    _blocks: [
                                      {
                                        _constructor: "Input",
                                        class: "toggle",
                                        type: "checkbox",
                                      },
                                      {
                                        _constructor: "Label",
                                        _blocks: [
                                          {
                                            _constructor: "Ref",
                                            path: "task.title"
                                          }
                                        ]
                                      },
                                      {
                                        _constructor: "Button",
                                        class: "destroy",
                                      }
                                    ]
                                  },
                                  {
                                    _constructor: "Input",
                                    class: "edit",
                                    value: {
                                      _constructor: "Ref",
                                      path: "task.title"
                                    }
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    _constructor: "Footer",
                    class: "footer",
                    _blocks: [
                      {
                        _constructor: "Span",
                        class: "todo-count",
                        _blocks: [
                          {
                            _constructor: "Strong",
                            _blocks: [
                              "1"
                            ]
                          },
                          {
                            _constructor: "Span",
                          },
                          {
                            _constructor: "Span",
                            _blocks: [
                              "item"
                            ]
                          },
                          {
                            _constructor: "Span",
                            _blocks: [
                              " left"
                            ]
                          }
                        ]
                      },
                      {
                        _constructor: "Ul",
                        class: "filters",
                        _blocks: [
                          {
                            _constructor: "Li",
                            _blocks: [
                              {
                                _constructor: "A",
                                href: "#/",
                                class: "selected",
                                _blocks: [
                                  "All"
                                ]
                              }
                            ]
                          },
                          {
                            _constructor: "Span",
                          },
                          {
                            _constructor: "Li",
                            _blocks: [
                              {
                                _constructor: "A",
                                href: "#/active",
                                _blocks: [
                                  "Active"
                                ]
                              }
                            ]
                          },
                          {
                            _constructor: "Span",
                          },
                          {
                            _constructor: "Li",
                            _blocks: [
                              {
                                _constructor: "A",
                                href: "#/completed",
                                _blocks: [
                                  "Compoleted"
                                ]
                              }
                            ]
                          },
                        ]
                      },
                      {
                        _constructor: "Button",
                        class: "clear-completed",
                        _blocks: [
                          "Clear Completed"
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            _constructor: "Footer",
            class: "info",
            _blocks: [
              {
                _constructor: "P",
                _blocks: [
                  "Double-click to edit a todo"
                ]
              },
              {
                _constructor: "P",
                _blocks: [
                  "Created by ",
                  {
                    _constructor: "A",
                    href: "http://github.com/emeitch/",
                    _blocks: [
                      "Hideyuki MORITA (emeitch)"
                    ]
                  }
                ]
              },
              {
                _constructor: "P",
                _blocks: [
                  "Part of ",
                  {
                    _constructor: "A",
                    href: "http://todomvc.com",
                    _blocks: [
                      "TodoMVC"
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    }
  }
}

var h = maquette.h;
var projector = maquette.createProjector();

// todo: 上から探索しているだけで、レキシカルな探索になってない
function searchRef(tree, refererPath, key) {
  function _traverseRef(node, path) {
    if (!node || path.length == 0) {
      return undefined;
    } else if (Object.getOwnPropertyNames(node).includes(key)) {
      return node[key];
    } else {
      var restLength = path.length - 1
      var rest = path.slice(-restLength);
      return _traverseRef(node[path[0]], rest);
    }
  }
  return _traverseRef(tree, refererPath);
}
// //// test
// var tree = {
//   a: 1,
//   b: 2, 
//   c:{
//     ca: 4,
//     cb: {
//       cba: "b",
//       cbb: "ca",
//       cbc: "nothing"
//     }
//   }
// };
// console.log(searchRef(tree, ["c", "cb", "cba"], "b")); // 2
// console.log(searchRef(tree, ["c", "cb", "cbb"], "ca")); // 4
// console.log(searchRef(tree, ["c", "cb", "cbc"], "nothing")); // undefined

function flatten(array) {
  return Array.prototype.concat.apply([], array);
}

function vdom(app) {
  function _traverse(node, path, context) {    
    if (typeof(node) === "string") {
      return [node];
    };
        
    var constructorName = node._constructor;
    var properties = Object
      .getOwnPropertyNames(node)
      .filter(n => n[0] != "_")
      .reduce((p, c) => {
          p[c] = node[c]; return p 
        } , {});
    var blocks = node._blocks ? node._blocks : []
    
    function _getReference(refPath) {
      var symbols = refPath.split(".");
      var ref = (context && context[symbols[0]]) || searchRef(app, path, symbols[0]);
      
      if (ref === undefined) {
        throw `"${ref}"(Ref{path:"${refPath}"}) not found`
      }
      
      var restLength = symbols.length - 1;
      var rest = symbols.slice(-restLength);
      for (var sym of rest) {
        if (sym == "map") {
          if (ref._constructor = "Array") {
            ref = ref._blocks;
          }
          var argName = Object.keys(properties)[0];          
          ref = flatten(ref.map(arg => {
            var p = path.concat(["_blocks"]);
            var ctx = {};
            ctx[argName] = arg; // todo: 何重にもmapされることを考えると重ねる必要あり!
            return flatten(blocks.map(b => _traverse(b, p, ctx)));
          }));
        } else {
          ref = ref[sym];
          if (ref === undefined) {
            throw `"${ref}"(Ref{path:${path}}) not found`;
          }
        }
      }
      
      return ref;
    }
    
    if (constructorName === "Ref") {
      return _getReference(properties.path);
    }
    
    try {
      constructor = _getReference(constructorName);
      return constructor; // todo: 取り出せたコンストラクタ実態の実行が必要
    } catch(e) {
      // todo: dom向け特別処理なので一般化する
      var p = path.concat(["_blocks"]);
      var children = flatten(blocks.map(b => _traverse(b, p, context)));
      return [h(constructorName, properties, children)];
    }
  }
  
  var body = app.presentation.body;
  return _traverse(body, ["presentation", "body"])[0];
}

// Initializes the projector 
window.document.addEventListener('DOMContentLoaded', function () {
   projector.replace(window.document.body, () => vdom(json.TodoMVC));
});

</script>
</head>
<body>
</body>
</html>