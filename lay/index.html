<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>lay prototype</title>
<link rel="stylesheet" href="./base.css">
<link rel="stylesheet" href="./index.css">
<script src="maquette.min.js"></script>
<script>
var jsonObject = {
  TodoMVC: {
    domain: {
      Task: {
        _op: "Entity",
        title: "string",
        completed: "bool"
      },
      tasks: {
        _stuff: [
          {
            _op: "Task",
            title: "buy a milk",
            completed: false,
          },
          {
            _op: "Task",
            title: "buy a coffee",
            completed: false,
          },
          {
            _op: "Task",
            title: "buy a tea",
            completed: true,
          }
        ]
      }
    },
    presentation: {
      body: {
        _op: "Body",
        _stuff: [
          {
            _op: "Section",
            class: "todoapp",
            _stuff: [
              {
                _op: "Div",
                _stuff: [
                  {
                    _op: "Header",
                    class: "header",
                    _stuff: [
                      {
                        _op: "H1",
                        _stuff: [
                          "todos"
                        ]
                      },
                      {
                        _op: "Input",
                        class: "new-todo",
                        placeholder: "What needs to be done?"
                      }
                    ]
                  },
                  {
                    _op: "Section",
                    class: "main",
                    _stuff: [
                      {
                        _op: "Input",
                        class: "toggle-all",
                        type: "checkbox"
                      },
                      {
                        _op: "Ul",
                        class: "todo-list",
                        _stuff: {
                          _op: "Chain",
                          _stuff: [
                            { _op: "domain" },
                            { _op: "tasks" },
                            { 
                              _op: "map",
                              _stuff: [
                                {
                                  _op: "Lambda",
                                  task: "Task",
                                  _stuff: [
                                    {
                                      _op: "Li",
                                      _stuff: [
                                        {
                                          _op: "Div",
                                          class: "view",
                                          _stuff: [
                                            {
                                              _op: "Input",
                                              class: "toggle",
                                              type: "checkbox",
                                            },
                                            {
                                              _op: "Label",
                                              _stuff: {
                                                _op: "Chain",
                                                _stuff: [
                                                  { _op: "task" },
                                                  { _op: "title" }
                                                ]
                                              }
                                            },
                                            {
                                              _op: "Button",
                                              class: "destroy",
                                            }
                                          ]
                                        },
                                        {
                                          _op: "Input",
                                          class: "edit",
                                          value: {
                                            _op: "Chain",
                                            _stuff: [
                                              { _op: "task" },
                                              { _op: "title" }
                                            ]
                                          }
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      }
                    ]
                  },
                  {
                    _op: "Footer",
                    class: "footer",
                    _stuff: [
                      {
                        _op: "Span",
                        class: "todo-count",
                        _stuff: [
                          {
                            _op: "Strong",
                            _stuff: {
                              _op: "Chain",
                              _stuff: [
                                { _op: "domain" },
                                { _op: "tasks" },
                                { _op: "count" }
                              ]
                            }
                          },
                          {
                            _op: "Span",
                            _stuff: " "
                          },
                          {
                            _op: "Span",
                            _stuff: "item"
                          },
                          {
                            _op: "Span",
                            _stuff: " left"
                          }
                        ]
                      },
                      {
                        _op: "Ul",
                        class: "filters",
                        _stuff: [
                          {
                            _op: "Li",
                            _stuff: [
                              {
                                _op: "A",
                                href: "#/",
                                class: "selected",
                                _stuff: "All"
                              }
                            ]
                          },
                          {
                            _op: "Span",
                            class: "span"
                          },
                          {
                            _op: "Li",
                            _stuff: [
                              {
                                _op: "A",
                                href: "#/active",
                                _stuff: "Active"
                              }
                            ]
                          },
                          {
                            _op: "Span",
                            class: "span"
                          },
                          {
                            _op: "Li",
                            _stuff: [
                              {
                                _op: "A",
                                href: "#/completed",
                                _stuff: "Completed"
                              }
                            ]
                          },
                        ]
                      },
                      {
                        _op: "Button",
                        class: "clear-completed",
                        _stuff: "Clear Completed"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            _op: "Footer",
            class: "info",
            _stuff: [
              {
                _op: "P",
                _stuff: "Double-click to edit a todo"
              },
              {
                _op: "P",
                _stuff: [
                  "Created by ",
                  {
                    _op: "A",
                    href: "http://github.com/emeitch/",
                    _stuff: "Hideyuki MORITA (emeitch)"
                  }
                ]
              },
              {
                _op: "P",
                _stuff: [
                  "Part of ",
                  {
                    _op: "A",
                    href: "http://todomvc.com",
                    _stuff: "TodoMVC"
                  }
                ]
              }
            ]
          }
        ]
      }
    }
  }
}

function flatten(array) {
  return Array.prototype.concat.apply([], array);
}

const LITERAL_TYPES = [
  "number",
  "string",
  "boolean"
];

const HTML_TAGS = [
  "Body",
  "Section",
  "Footer",
  "Header",
  "P",
  "Ul",
  "Li",
  "Input",
  "Button",
  "Div",
  "Span",
  "H1",
  "Label",
  "Strong",
  "A",
];

function box(src={}) {
  const type = typeof(src);
  if (LITERAL_TYPES.includes(type)) {
    return new Box(JSON.stringify(src));
  }
    
  if (HTML_TAGS.includes(src._op)) {
    return DOM.parse(src);
  }
    
  return Box.parse(src);
}

// Props base class for getOwnPropertyNames
class PropsBase {
  constructor(raws={}) {
    Object.assign(this, raws);
  }
  
  clone(params) {
    return Object.assign(new this.constructor(), this, params);
  }
  
  eval(env) {
    const keys = Object.getOwnPropertyNames(this);
    const raws = keys.reduce((p, k) => 
      Object.assign(p, {[k]: this[k].eval(env)}),
      {});
    return new this.constructor(raws);
  }
}
class Props extends PropsBase {
  map(owner) {
    return Map.create(owner);
  }
  
  count(owner) {
    return Literal.create(owner.stuff.raws.length)
  }
}

class Stuff {
  constructor(raws=[]) {
    this.raws = raws;
  }
  
  clone(params) {
    return Object.assign(new this.constructor(), this, params);
  }
  
  get one() {
    return this.raws[0];
  }
  
  eval(env) {
    const raws = this.raws.map(c => c.eval(env));
    return new this.constructor(raws).flatten();
  }
  
  flatten() {
    const raws = this.raws.reduce((a, raw) => {
      if (raw instanceof Stuff) {
        return a.concat(raw.raws);
      } else {
        return a.concat([raw]);
      }
    }, []);
    return new this.constructor(raws);
  }
  
  map(f) {
    return new Stuff(this.raws.map(f));
  }
}

const plugins = {};
class Plugin {
  static get(key) {
    return plugins[key];
  }

  static set(key, box) {
    plugins[key] = box;
  }
}

class Environment {
  constructor(root) {
    this.root = root;
    this.stack = [];
  }
      
  push(box, block) {
    this.stack.push(box);
    const result = block();
    this.stack.pop();
    return result;
  }
    
  parents(box, target, parents) {
    // todo 効率が悪い実装なので後で改善する
    const ps = parents.slice(); // dupulication
    ps.push(target);
    
    if (box == target) {
      return ps;
    }

    for (let key of target.keys) {
      const prop = target.props[key];
      const p = this.parents(box, prop, ps);
      if (p.length > 0) {
        return p;
      }
    }

    for (let raw of target.stuff.raws) {
      const p = this.parents(box, raw, ps)
      if (p.length > 0) {
        return p;
      }
    }
    
    return [];
  }

  context(current) {
    const parents = this.parents(current, this.root, []);
    const context = parents.concat(this.stack);
    context.reverse();
    return context;
  }
  
  ref(current, sym) {
    for (let box of this.context(current)) {
      const prop = box.props[sym];
      if (prop) {
        if (typeof(prop) == "function") {
          return prop(box);
        } else {
          return prop;
        }
      }
    }
    
    const plugin = Plugin.get(sym);
    if (plugin) {
      return plugin;
    }

    try {
      const parsed = JSON.parse(sym);
      const type = typeof(parsed)
      if (type === "number") {
        return Literal.create(parsed);
      } else if (type === "string") {
        return Literal.create(parsed);
      } else if (type === "boolean") {
        return Literal.create(parsed);
      }
    } catch(e) {
      if (e.constructor !== SyntaxError) {
        throw e;
      }
    }

    return undefined;
  }
}

class Ref {
  constructor(op, props=new Props(), stuff=new Stuff()) {
    this.op = op;
    
    // todo Refには本質的に不要。ナイーブな実装なのでどうにかしたい
    this.props = props;
    this.stuff = stuff;
  }
    
  clone(params) {
    return Object.assign(new this.constructor(), this, params);
  }
  
  get keys() {
    return Object.getOwnPropertyNames(this.props)
  }
          
  eval(env) {
    return env.ref(this, this.op);
  }
}

class Box extends Ref {
  static parse(src, ...inheritedOptions) {
    {
      const length = Object.getOwnPropertyNames(src).length;
      const opOnly = src._op != undefined && length == 1;
      if (opOnly) {
        return new Ref(src._op);
      }
    }
        
    const op = src._op ? src._op : "Box";
        
    const props = Object.getOwnPropertyNames(src)
      .filter(k => k[0] !== '_')
      .reduce((p, k) => Object.assign(p, {[k]: box(src[k])}), {});

    const s = src._stuff;
    const stf = s ? (Array.isArray(s) ? s : [s]) : [];
    const stuff = stf.map(i => box(i));
        
    return new this(
      op, 
      new Props(props),
      new Stuff(stuff),
      ...inheritedOptions);
  }
        
  constructor(op="Box", props=new Props(), stuff=new Stuff(), evaluated=false) {
    super(op, props, stuff);
    this.props = props;
    this.stuff = stuff;
    this.evaluated = evaluated;
  }
    
  clone(params) {
    return Object.assign(new this.constructor(), this, params);
  }
    
  eval(env) {
    if (this.evaluated) {
      return this;
    }
    
    const operator = env.ref(this, this.op);
    if (!operator) {
      throw "Operator not found";
    }    
    
    const result = operator.apply(this, env);
    return result.eval(env);
  }
  
  apply(operand, env) {
    const props = operand.props.eval(env);
    const stuff = operand.stuff.eval(env);

    return operand.clone({
      props,
      stuff,
      evaluated: true
    });
  }  
}
Plugin.set("Box", new Box(undefined, undefined, undefined, true));

class Map extends Box {
  static create(owner) {
    return new this("Map", undefined, undefined, owner)
  }
  
  constructor(op, props, stuff, owner) {
    super(op, props, stuff)
    this.owner = owner;
  }
  
  apply(operand, env) {
    const block = operand.stuff.one;
    const argkey = block.keys[0]; // todo key値の型と一致するか確認
    return this.owner.stuff.map(item => {
      // todo stuffにMapボックスが存在すると無限ループになるのをうまく解決 / そもそもstuffがMapボックスになる状況のセマンティクスとは何か?
      const arg = item.eval(env);
      const props = block.props.clone({[argkey]: arg});
      const b = block.clone({props});
      return b.eval(env);
    });
  }
}

class Literal extends Box {
  static create(value) {
    return new this(value);
  }
  
  constructor(value) {
    super("Literal", undefined, undefined, true);
    this.value = value;
  }

  apply(operand, env) {
    return this;
  }  
}

class Chain extends Box {
  apply(operand, env) {
    const raws = operand.stuff.raws;
    const chain = raws.slice(-(raws.length-1));
    const receiver = operand.stuff.one.eval(env);
    return chain.reduce((result, chained) => {
      const r = env.push(result, () => chained.eval(env));
      if (!r) {
        throw "chain evaluated value is not set."
      }
      return r;
    },
    receiver);
  }
}
Plugin.set("Chain", new Chain());

class Lambda extends Box {
  apply(operand, env) {
    const item = operand.stuff.one;
    return env.push(operand, () => item.eval(env));
  }
}
Plugin.set("Lambda", new Lambda());

class Entity extends Box {
}
Plugin.set("Entity", new Entity());

class DOM extends Box {
  constructor(tag, props, stuff) {
    // todo 適切なopを指定する
    super("Box", props, stuff);
    this.tag = tag;
  }
  
  render() {
    const attrs = this.keys.reduce((r, n) => Object.assign(r, {[n]: this.props[n].value}), {});
    const children = flatten(this.stuff.raws.map(b => {
      const self = this;
      
      if (b.value != undefined) {
        return b.value.toString();
      }
      
      if (b.render) {
        return b.render();
      }
      
      return [];
    }));
    return [maquette.h(
      this.tag,
      attrs,
      children
    )];
  }
}

function vdom(src) { 
  const env = new Environment(src);
  const app = src.eval(env);
  console.log(app);
  return app.props.presentation.props.body.render()[0];
}

const src = box(jsonObject).props.TodoMVC;

// Initializes the projector 
var projector = maquette.createProjector();
window.document.addEventListener('DOMContentLoaded', function () {
   projector.replace(window.document.body, () => vdom(src));
});

</script>
</head>
<body>
</body>
</html>