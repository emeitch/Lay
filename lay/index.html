<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>lay prototype</title>
<link rel="stylesheet" href="./base.css">
<link rel="stylesheet" href="./index.css">
<script src="maquette.min.js"></script>
<script>
var jsonObject = {
  TodoMVC: {
    domain: {
      Task: {
        _proto: "Entity",
        title: "string",
        completed: "bool"
      },
      tasks: {
        _items: [
          {
            _proto: "Task",
            title: "buy a milk",
            completed: false,
          },
          {
            _proto: "Task",
            title: "buy a coffee",
            completed: false,
          },
          {
            _proto: "Task",
            title: "buy a tea",
            completed: true,
          }
        ]
      }
    },
    presentation: {
      _proto: "DOM::Document",
      body: {
        _proto: "Body",
        _items: [
          {
            _proto: "Section",
            class: "todoapp",
            _items: [
              {
                _proto: "Div",
                _items: [
                  {
                    _proto: "Header",
                    class: "header",
                    _items: [
                      {
                        _proto: "H1",
                        _items: [
                          "todos"
                        ]
                      },
                      {
                        _proto: "Input",
                        class: "new-todo",
                        placeholder: "What needs to be done?"
                      }
                    ]
                  },
                  {
                    _proto: "Section",
                    class: "main",
                    _items: [
                      {
                        _proto: "Input",
                        class: "toggle-all",
                        type: "checkbox"
                      },
                      {
                        _proto: "Ul",
                        class: "todo-list",
                        _items: [
                          {
                            _proto: "domain.tasks.map",
                            _items: [
                              {
                                task: "Task",
                                _items: [
                                  {
                                    _proto: "Li",
                                    _items: [
                                      {
                                        _proto: "Div",
                                        class: "view",
                                        _items: [
                                          {
                                            _proto: "Input",
                                            class: "toggle",
                                            type: "checkbox",
                                          },
                                          {
                                            _proto: "Label",
                                            _items: [
                                              {
                                                _proto: "Ref",
                                                _path: "task.title"
                                              }
                                            ]
                                          },
                                          {
                                            _proto: "Button",
                                            class: "destroy",
                                          }
                                        ]
                                      },
                                      {
                                        _proto: "Input",
                                        class: "edit",
                                        value: {
                                          _proto: "Ref",
                                          _path: "task.title"
                                        }
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    _proto: "Footer",
                    class: "footer",
                    _items: [
                      {
                        _proto: "Span",
                        class: "todo-count",
                        _items: [
                          {
                            _proto: "Strong",
                            _item: "1"
                          },
                          {
                            _proto: "Span",
                          },
                          {
                            _proto: "Span",
                            _item: "item"
                          },
                          {
                            _proto: "Span",
                            _item: " left"
                          }
                        ]
                      },
                      {
                        _proto: "Ul",
                        class: "filters",
                        _items: [
                          {
                            _proto: "Li",
                            _items: [
                              {
                                _proto: "A",
                                href: "#/",
                                class: "selected",
                                _item: "All"
                              }
                            ]
                          },
                          {
                            _proto: "Span",
                          },
                          {
                            _proto: "Li",
                            _items: [
                              {
                                _proto: "A",
                                href: "#/active",
                                _item: "Active"
                              }
                            ]
                          },
                          {
                            _proto: "Span",
                          },
                          {
                            _proto: "Li",
                            _items: [
                              {
                                _proto: "A",
                                href: "#/completed",
                                _item: "Completed"
                              }
                            ]
                          },
                        ]
                      },
                      {
                        _proto: "Button",
                        class: "clear-completed",
                        _item: "Clear Completed"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            _proto: "Footer",
            class: "info",
            _items: [
              {
                _proto: "P",
                _item: "Double-click to edit a todo"
              },
              {
                _proto: "P",
                _items: [
                  "Created by ",
                  {
                    _proto: "A",
                    href: "http://github.com/emeitch/",
                    _item: "Hideyuki MORITA (emeitch)"
                  }
                ]
              },
              {
                _proto: "P",
                _items: [
                  "Part of ",
                  {
                    _proto: "A",
                    href: "http://todomvc.com",
                    _item: "TodoMVC"
                  }
                ]
              }
            ]
          }
        ]
      }
    }
  }
}

function flatten(array) {
  return Array.prototype.concat.apply([], array);
}

const PRIMITIVE_TYPES = [
  "number",
  "string",
  "boolean"
];

const HTML_TAGS = [
  "Body",
  "Section",
  "Footer",
  "Header",
  "P",
  "Ul",
  "Li",
  "Input",
  "Button",
  "Div",
  "Span",
  "H1",
  "Label",
  "Strong",
  "A",
]

function box(src={}, parent=undefined) {
  const type = typeof(src);
  if (PRIMITIVE_TYPES.includes(type)) {
    return new Primitive(src, parent);
  }
  
  if (src._proto === "Ref") {
    return new Ref(src, parent);
  }
  
  if (HTML_TAGS.includes(src._proto)) {
    return new DOM(src, parent);
  }
  
  if (src._proto === "Entity") {
    return new Entity(src, parent);
  }

  return new Box(src, parent);
}

class Box {
  constructor(src, parent) {
    this._parent = parent;
    
    this._protoPath = src._proto ? src._proto : "Box"
    
    Object.getOwnPropertyNames(src)
    .filter(n => n[0] != "_")
    .forEach(c => {
      this[c] = box(src[c], this);
    });
    
    let items = [];
    if (src._item) {
      items = [src._item];
    } else if (src._items) {
      items = src._items;
    }
    this._items = items.map(b => box(b, this));
  }
  
  _clone(parent) {
    let copy = new this.constructor({}, parent);
    
    copy._protoPath = this._protoPath;
    
    this._keys.forEach(n => {
      copy[n] = this[n]._clone(copy);
    });
    
    copy._items = this._items.map(c => c._clone(copy));
        
    return copy;
  }
  
  get _proto() {
    return this._ref(this._protoPath);
  }
  
  get _keys() {
    return Object.getOwnPropertyNames(this)
      .filter(n => n[0] != "_");
  }
  
  get _props() {
    return this._keys
      .reduce((r, n) => {
        r[n] = this[n];
        return r;
      }, {});
  }
  
  get _item() {
    return this._items[0];
  }
  
  _eval(parent=undefined) {
    return this._proto._apply(this, parent);
  }
  
  _apply(args, parent) {
    let result = args._clone(parent);
    result._keys.forEach(n => {
      result[n] = result[n]._eval(result);
    });
    result._items = result._items.map(c => c._eval(result));
    return result;
  }
  
  _ref(path) {
    const syms = path.split(".");
    
    if (this[syms[0]]) {
      return syms.reduce((p, s) => p[s], this);      
    }
    
    if (this._parent) { 
      return this._parent._ref(path);
    }
    
    return box(); // todo ダミーBoxを返している状況なので変更する
  }
  
  _render() {
    return flatten(this._items.map(b => b._render()));
  }
  
  get map() {
    class Map extends Box {
      _apply(argbox, parent) {
        const block = argbox._item;
        const barg = argbox._item._keys[0]; // todo key値の型と一致するか確認
        const dst = box({}, parent);
        dst._items = this._parent._items.map(item => {
          // todo _itemsにMapボックスが存在すると無限ループになるのをうまく解決 / そもそも_itemsがMapボックスになる状況のセマンティクスとは何か?
          const n = block._clone(dst);
          n[barg] = item;
          return n._eval(dst);
        });
        return dst;
      }
    }
    return new Map({}, this);
  }
}

class Primitive extends Box {
  constructor(src, parent) {
    super({_proto: "Primitive"}, parent);
    this._val = src;
  }
  
  _clone(parent) {
    let copy = super._clone(parent);
    copy._val = this._val;
    return copy;
  }
  
  _render() {
    return [this._val];
  }
}

class Entity extends Box {
}

class RefProto extends Box {
  _apply(argbox, parent) {
    const b = argbox._ref(argbox._path);
    return b._eval();
  }
}
const REF_PROTO = new RefProto({});

class Ref extends Box {
  constructor(src, parent) {
    super(src, parent);
    this._path = src._path;
  }
  
  get _proto() {
    return REF_PROTO;
  }
  
  _clone(parent) {
    let copy = super._clone(parent);
    copy._path = this._path;
    return copy;
  }
}

class DOM extends Box {
  constructor(src, parent) {
    super(src, parent);
    this._tag = src._proto;
  }

  _clone(parent) {
    let copy = super._clone(parent);
    copy._tag = this._tag;
    return copy;
  }

  _render() {
    const attrs = this._keys.reduce((r, n) => Object.assign(r, {[n]: this[n]._render()[0]}), {});
    const children = flatten(this._items.map(b => b._render()));
    return [maquette.h(
      this._tag,
      attrs,
      children
    )];
  }
}

function vdom(src) { 
  const app = src._eval();
  return app.presentation.body._render()[0];
}

const tree = box(jsonObject);

// Initializes the projector 
var projector = maquette.createProjector();
window.document.addEventListener('DOMContentLoaded', function () {
   projector.replace(window.document.body, () => vdom(tree.TodoMVC));
});

</script>
</head>
<body>
</body>
</html>