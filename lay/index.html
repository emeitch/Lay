<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>lay prototype</title>
<link rel="stylesheet" href="./base.css">
<link rel="stylesheet" href="./index.css">
<script src="maquette.min.js"></script>
<script>
var json = {
  TodoMVC: {
    domain: {
      tasks: [
        {
          title: "buy a milk",
          completed: false,
        },
        {
          title: "buy a coffee",
          completed: false,
        },
        {
          title: "buy a tea",
          completed: true,
        }
      ]
    },
    presentation: {
      _type: "DOM::Document",
      body: {
        _type: "Body",
        _blocks: [
          {
            _type: "Section",
            class: "todoapp",
            _blocks: [
              {
                _type: "Div",
                _blocks: [
                  {
                    _type: "Header",
                    class: "header",
                    _blocks: [
                      {
                        _type: "H1",
                        _blocks: [
                          "todos"
                        ]
                      },
                      {
                        _type: "Input",
                        class: "new-todo",
                        placeholder: "What needs to be done?"
                      }
                    ]
                  },
                  {
                    _type: "Section",
                    class: "main",
                    _blocks: [
                      {
                        _type: "Input",
                        class: "toggle-all",
                        type: "checkbox"
                      },
                      {
                        _type: "Ul",
                        class: "todo-list",
                        _blocks: [
                          {
                            _type: "domain.tasks.map",
                            task: "Task",
                            _blocks: [
                              {
                                _type: "Li",
                                _blocks: [
                                  {
                                    _type: "Div",
                                    class: "view",
                                    _blocks: [
                                      {
                                        _type: "Input",
                                        class: "toggle",
                                        type: "checkbox",
                                      },
                                      {
                                        _type: "Label",
                                        _blocks: [
                                          {
                                            _type: "Ref",
                                            _blocks: [
                                              "task.title"
                                            ]
                                          }
                                        ]
                                      },
                                      {
                                        _type: "Button",
                                        class: "destroy",
                                      }
                                    ]
                                  },
                                  {
                                    _type: "Input",
                                    class: "edit",
                                    value: {
                                      _type: "Ref",
                                      _blocks: [
                                        "task.title"
                                      ],
                                    }
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    _type: "Footer",
                    class: "footer",
                    _blocks: [
                      {
                        _type: "Span",
                        class: "todo-count",
                        _blocks: [
                          {
                            _type: "Strong",
                            _blocks: [
                              "1"
                            ]
                          },
                          {
                            _type: "Span",
                          },
                          {
                            _type: "Span",
                            _blocks: [
                              "item"
                            ]
                          },
                          {
                            _type: "Span",
                            _blocks: [
                              " left"
                            ]
                          }
                        ]
                      },
                      {
                        _type: "Ul",
                        class: "filters",
                        _blocks: [
                          {
                            _type: "Li",
                            _blocks: [
                              {
                                _type: "A",
                                href: "#/",
                                class: "selected",
                                _blocks: [
                                  "All"
                                ]
                              }
                            ]
                          },
                          {
                            _type: "Span",
                          },
                          {
                            _type: "Li",
                            _blocks: [
                              {
                                _type: "A",
                                href: "#/active",
                                _blocks: [
                                  "Active"
                                ]
                              }
                            ]
                          },
                          {
                            _type: "Span",
                          },
                          {
                            _type: "Li",
                            _blocks: [
                              {
                                _type: "A",
                                href: "#/completed",
                                _blocks: [
                                  "Compoleted"
                                ]
                              }
                            ]
                          },
                        ]
                      },
                      {
                        _type: "Button",
                        class: "clear-completed",
                        _blocks: [
                          "Clear Completed"
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            _type: "Footer",
            class: "info",
            _blocks: [
              {
                _type: "P",
                _blocks: [
                  "Double-click to edit a todo"
                ]
              },
              {
                _type: "P",
                _blocks: [
                  "Created by ",
                  {
                    _type: "A",
                    href: "http://github.com/emeitch/",
                    _blocks: [
                      "Hideyuki MORITA (emeitch)"
                    ]
                  }
                ]
              },
              {
                _type: "P",
                _blocks: [
                  "Part of ",
                  {
                    _type: "A",
                    href: "http://todomvc.com",
                    _blocks: [
                      "TodoMVC"
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    }
  }
}

var h = maquette.h;
var projector = maquette.createProjector();

// todo: 上から探索しているだけで、レキシカルな探索になってない
function searchRef(tree, refererPath, key) {
  function _traverseRef(node, path) {
    if (!node || path.length == 0) {
      return undefined;
    } else if (Object.getOwnPropertyNames(node).includes(key)) {
      return node[key];
    } else {
      var restLength = path.length - 1
      var rest = path.slice(-restLength);
      return _traverseRef(node[path[0]], rest);
    }
  }
  return _traverseRef(tree, refererPath);
}
// //// test
// var tree = {
//   a: 1,
//   b: 2, 
//   c:{
//     ca: 4,
//     cb: {
//       cba: "b",
//       cbb: "ca",
//       cbc: "nothing"
//     }
//   }
// };
// console.log(searchRef(tree, ["c", "cb", "cba"], "b")); // 2
// console.log(searchRef(tree, ["c", "cb", "cbb"], "ca")); // 4
// console.log(searchRef(tree, ["c", "cb", "cbc"], "nothing")); // undefined

function flatten(array) {
  return Array.prototype.concat.apply([], array);
}

function vdom(app) {
  function _traverse(node, path, context) {
    if (typeof(node) === "string") {
      return [node];
    };
    
    var type = node._type;
    var properties = Object
      .getOwnPropertyNames(node)
      .filter(n => n[0] != "_")
      .reduce((p, c) => {
          p[c] = node[c]; return p 
        } , {});
    var blocks = node._blocks ? node._blocks : []
    
    if (type === "Ref") {
      var p = path.concat(["_blocks"]);
      return flatten(blocks.map(block => {
        var symbols = block.split(".");
        var ref = (context && context[symbols[0]]) || searchRef(app, path, symbols[0]);
        if (ref) {
          var restLength = symbols.length - 1;
          var rest = symbols.slice(-restLength);
          for (var sym of rest) {
            if (sym == "map") {
              var argName = Object.keys(properties)[0];          
              ref = flatten(ref.map(arg => {
                var p = path.concat(["_blocks"]);
                var ctx = {};
                ctx[argName] = arg; // todo: 何重にもmapされることを考えると重ねる必要あり!
                return flatten(blocks.map(b => _traverse(b, p, ctx)));
              }));
            } else {
              ref = ref[sym];
            }
          }
          return ref;
        } else {
          throw "ref not found";
        }
      }));
    }
    
    var symbols = type.split(".");
    var ref = (context && context[symbols[0]]) || searchRef(app, path, symbols[0]);
    if (ref) {
      var restLength = symbols.length - 1;
      var rest = symbols.slice(-restLength);
      for (var sym of rest) {
        if (sym == "map") {
          var argName = Object.keys(properties)[0];          
          ref = flatten(ref.map(arg => {
            var p = path.concat(["_blocks"]);
            var ctx = {};
            ctx[argName] = arg; // todo: 何重にもmapされることを考えると重ねる必要あり!
            return flatten(blocks.map(b => _traverse(b, p, ctx)));
          }));
        } else {
          ref = ref[sym];
        }
      }
      return ref;
    }
    
    var p = path.concat(["_blocks"]);
    var children = flatten(blocks.map(b => _traverse(b, p, context)));
    return [h(type, properties, children)];
  }
  
  var body = app.presentation.body;
  return _traverse(body, ["presentation", "body"])[0];
}

// Initializes the projector 
window.document.addEventListener('DOMContentLoaded', function () {
   projector.replace(window.document.body, () => vdom(json.TodoMVC));
});

</script>
</head>
<body>
</body>
</html>