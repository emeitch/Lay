{"version":3,"sources":["webpack:///webpack/bootstrap 81c0569bb5c6a0cefd38","webpack:///./src/uuid.js","webpack:///./src/ontology.js","webpack:///./src/store.js","webpack:///./src/app.js","webpack:///./src/log.js","webpack:///./src/obj.js"],"names":["UUID","uuid","i","random","Math","toString","origin","constructor","generateUUIDString","urn","invalidate","nameKey","transaction","transactionTime","Store","logs","activeLogsCache","invalidationLogsCache","logid","cond","hasOwnProperty","log","keys","Object","every","k","JSON","stringify","push","id","key","at","Date","cacheIndex","alogs","Map","ilogs","_","ilog","get","delete","Array","from","values","actives","activeLogs","length","tlogs","findLogs","undefined","tlog","tid","val","obj","name","al","set","positive","getLog","il","block","addLog","syncCache","ttlog","logWithTransaction","args","attrs","doTransaction","console","Log","at_","in_","in","Obj","store","activeLog"],"mappings":"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","file":"bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// identity function for calling harmony imports with the correct context\n \t__webpack_require__.i = function(value) { return value; };\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 3);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 81c0569bb5c6a0cefd38","export default class UUID {\n  static generateUUIDString() {\n    // UUID ver 4 / RFC 4122\n    var uuid = \"\", i, random;\n    for (i = 0; i < 32; i++) {\n      random = Math.random() * 16 | 0;\n      \n      if (i == 8 || i == 12 || i == 16 || i == 20) {\n        uuid += \"-\";\n      }\n      uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);\n    }\n    return uuid;\n  }\n  \n  constructor() {\n    this.origin = this.constructor.generateUUIDString();\n  }\n  \n  get urn() {\n    return \"urn:uuid:\" + this.origin;\n  }\n  \n  toJSON() {\n    return this.urn;\n  }\n  \n  toString() {\n    return this.urn;\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/uuid.js","import UUID from './uuid';\n\nexport const invalidate = new UUID();\n\nexport const nameKey = new UUID();\n\nexport const transaction = new UUID();\n\nexport const transactionTime = new UUID();\n\n\n\n// WEBPACK FOOTER //\n// ./src/ontology.js","import UUID from './uuid';\nimport Log from './log';\nimport Obj from './obj';\nimport { nameKey, transaction, transactionTime, invalidate } from './ontology';\n\nexport default class Store {\n  constructor() {\n    this.logs = {};\n    this.activeLogsCache = {};\n    this.invalidationLogsCache = {};\n  }\n  \n  getLog(logid) {\n    return this.logs[logid];\n  }\n    \n  findLogs(cond) {\n    const logs = [];\n    \n    // todo: 線形探索になっているので高速化する\n    for (const logid in this.logs) {\n      if (this.logs.hasOwnProperty(logid)) {\n        const log = this.logs[logid];\n        \n        const keys = Object.keys(cond);\n        if (keys.every((k) => JSON.stringify(log[k]) == JSON.stringify(cond[k]))) {\n          logs.push(log);\n        }\n      }\n    }\n    \n    return logs;\n  }\n  \n  cacheIndex(id, key) {\n    return id + \"__\" + key;\n  }\n  \n  activeLogs(id, key, at=new Date()) {\n    const i = this.cacheIndex(id, key);\n    const alogs = new Map(this.activeLogsCache[i]);\n    const ilogs = new Map(this.invalidationLogsCache[i]);\n    for (let [_, ilog] of ilogs) {\n      const log = alogs.get(ilog.id);\n      if (log && (!ilog.at || ilog.at <= at)) {\n          alogs.delete(ilog.id);\n      }\n    }\n    return Array.from(alogs.values());\n  }\n  \n  activeLog(id, key, at=new Date()) {\n    const actives = this.activeLogs(id, key, at);\n    return actives[actives.length-1];\n  }\n  \n  obj(id) {\n    return new Obj(this, id);\n  }\n  \n  transactionObj(log) {\n    const tlogs = this.findLogs({id: log.logid, key: transaction});\n    \n    if (tlogs.length > 1) {\n      throw \"too many transaction logs\";\n    }\n    \n    if (tlogs.length == 0) {\n      return undefined;\n    }\n    \n    const tlog = tlogs[tlogs.length-1];\n    const tid = tlog.val;\n    return this.obj(tid);\n  }\n  \n  ref(name) {\n    const logs = this.findLogs({key: nameKey, val: name});\n    const log = logs[logs.length-1];\n    return log ? log.id : undefined;\n  }\n  \n  assign(name, id) {\n    // todo: ユニーク制約をかけたい\n    this.log(id, nameKey, name);\n  }\n  \n  syncCache(log) {\n    const i = this.cacheIndex(log.id, log.key);\n    const al = this.activeLogsCache[i] || new Map();\n    al.set(log.logid, log);\n    this.activeLogsCache[i] = al;\n    \n    if (log.key == invalidate) {\n      const positive = this.getLog(log.id);\n      const i = this.cacheIndex(positive.id, positive.key);\n      const il = this.invalidationLogsCache[i] || new Map();\n      il.set(log.logid, log);\n      this.invalidationLogsCache[i] = il;\n    }\n  }\n  \n  doTransaction(block) {\n    // todo: アトミックな操作に修正する\n    const addLog = (log) => {\n      this.logs[log.logid] = log;\n      this.syncCache(log);\n    };\n    const tid = new UUID();\n    const ttlog = new Log(tid, transactionTime, new Date());\n    \n    addLog(ttlog);\n    \n    const logWithTransaction = (...args) => {\n      const log = new Log(...args);\n      addLog(log);\n      const tlog = new Log(log.logid, transaction, tid);\n      addLog(tlog);\n      return log;\n    };\n    return block(logWithTransaction);\n  }\n  \n  log(...attrs) {\n    return this.doTransaction(logWithTransaction => {\n      return logWithTransaction(...attrs);\n    });\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/store.js","import UUID from './uuid';\nimport Store from './store';\n\nconsole.log(\"Lay: Hello, world!\");\n\n\n\n// WEBPACK FOOTER //\n// ./src/app.js","import UUID from './uuid';\n\nexport default class Log {\n  constructor(id, key, val, at_, in_) {\n    if (!id) {\n      throw \"id is required\";\n    }\n    \n    if (!key) {\n      throw \"key is required\";\n    }\n\n    this.logid = new UUID();\n    this.id = id;\n    this.key = key;\n    this.val = val;\n    this.at = at_;\n    this.in = in_;\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/log.js","import UUID from './uuid';\nimport { invalidate, transactionTime } from '../src/ontology';\n\nexport default class Obj {\n  constructor(store, id) {\n    this.store = store;\n    this.id = id;\n  }\n  \n  get(key) {\n    const log = this.store.activeLog(this.id, key);\n    if (!log) {\n      return undefined;\n    }\n    \n    const val = log.val;\n    if (val.constructor === UUID) {\n      return this.store.obj(val);  \n    } else {\n      return val;\n    }\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/obj.js"],"sourceRoot":""}